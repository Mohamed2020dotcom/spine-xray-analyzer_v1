<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spine X-ray Analyzer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #fff;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .subtitle {
            text-align: center;
            margin-bottom: 30px;
            opacity: 0.9;
            font-size: 1.1em;
        }
        
        .upload-section {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            padding: 40px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
            border: 3px dashed rgba(255,255,255,0.5);
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .upload-section:hover {
            border-color: rgba(255,255,255,0.8);
            background: rgba(255,255,255,0.15);
        }
        
        .upload-section.dragover {
            border-color: #4CAF50;
            background: rgba(76,175,80,0.2);
        }
        
        .upload-icon {
            font-size: 4em;
            margin-bottom: 20px;
        }
        
        .file-input-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 40px;
            border-radius: 50px;
            font-size: 1.1em;
            font-weight: bold;
            transition: transform 0.3s, box-shadow 0.3s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            border: none;
            cursor: pointer;
            display: inline-block;
            margin: 20px 0;
        }
        
        .file-input-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        
        input[type="file"] {
            display: none;
        }
        
        .analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .panel {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            color: #333;
        }
        
        .panel h2 {
            color: #2a5298;
            margin-bottom: 15px;
            font-size: 1.5em;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }
        
        canvas {
            max-width: 100%;
            height: auto;
            border-radius: 10px;
            background: #000;
            display: block;
            margin: 0 auto;
        }
        
        .metrics {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
        }
        
        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .metric-value {
            font-size: 2.5em;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .metric-label {
            font-size: 0.9em;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .report {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 30px;
            color: #333;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
        }
        
        .report h2 {
            color: #2a5298;
            margin-bottom: 20px;
            font-size: 1.8em;
        }
        
        .report-section {
            margin-bottom: 25px;
        }
        
        .report-section h3 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 1.3em;
        }
        
        .report-section ul {
            list-style-position: inside;
            line-height: 1.8;
            padding-left: 20px;
        }
        
        .report-section li {
            margin-bottom: 8px;
        }
        
        .warning {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
            color: #856404;
        }
        
        .info {
            background: #d1ecf1;
            border-left: 4px solid #17a2b8;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
            color: #0c5460;
        }
        
        #loading {
            display: none;
            text-align: center;
            padding: 40px;
            font-size: 1.3em;
        }
        
        .spinner {
            border: 4px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top: 4px solid #fff;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .demo-section {
            text-align: center;
            margin: 20px 0;
        }

        .demo-button {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 12px 30px;
            border-radius: 50px;
            font-size: 1em;
            font-weight: bold;
            transition: transform 0.3s, box-shadow 0.3s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            border: none;
            cursor: pointer;
            margin: 10px;
        }

        .demo-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üè• Spine X-ray Interactive Analyzer</h1>
        <p class="subtitle">Advanced Medical Image Processing & Analysis Tool</p>
        
        <div class="upload-section" id="dropZone">
            <div class="upload-icon">üìÅ</div>
            <h2 style="color: white; margin-bottom: 15px;">Upload Spine X-ray Image</h2>
            <p style="opacity: 0.9; margin-bottom: 20px;">Supports JPG, PNG formats</p>
            <button class="file-input-button" onclick="document.getElementById('imageInput').click()">
                Choose X-ray File
            </button>
            <input type="file" id="imageInput" accept="image/*">
            <p style="opacity: 0.8; margin-top: 15px; font-size: 0.9em;">Or drag and drop your image here</p>
        </div>

        <div class="demo-section">
            <p style="margin-bottom: 10px;">Don't have an image? Try the demo:</p>
            <button class="demo-button" onclick="loadDemoImage()">üìä Load Demo X-ray</button>
        </div>
        
        <div id="loading">
            <div class="spinner"></div>
            <p>Processing X-ray image...</p>
        </div>
        
        <div id="results" style="display: none;">
            <div class="analysis-grid">
                <div class="panel">
                    <h2>Original X-ray</h2>
                    <canvas id="originalCanvas"></canvas>
                </div>
                
                <div class="panel">
                    <h2>Enhanced & Edge Detection</h2>
                    <canvas id="edgeCanvas"></canvas>
                </div>
                
                <div class="panel">
                    <h2>Spine Centerline Analysis</h2>
                    <canvas id="analysisCanvas"></canvas>
                </div>
                
                <div class="panel">
                    <h2>Curvature Profile</h2>
                    <canvas id="chartCanvas"></canvas>
                </div>
            </div>
            
            <div class="panel">
                <h2>üìä Quantitative Measurements</h2>
                <div class="metrics" id="metrics"></div>
            </div>
            
            <div class="report">
                <h2>üìã Clinical Analysis Report</h2>
                
                <div class="warning">
                    <strong>‚ö†Ô∏è Important Medical Disclaimer:</strong> This is an automated analysis tool for educational purposes only. All findings must be confirmed by a qualified radiologist or orthopedic specialist. Do not use for clinical decision-making.
                </div>
                
                <div class="report-section">
                    <h3>üîç Radiographic Findings</h3>
                    <ul id="findings"></ul>
                </div>
                
                <div class="report-section">
                    <h3>üíä Recommended Clinical Actions</h3>
                    <ul>
                        <li><strong>Orthopedic Consultation:</strong> Evaluation by spine specialist recommended</li>
                        <li><strong>Standing Full-Spine Radiographs:</strong> For accurate Cobb angle measurement</li>
                        <li><strong>MRI Assessment:</strong> If neurological symptoms present</li>
                        <li><strong>Physical Therapy:</strong> Core strengthening and posture training</li>
                        <li><strong>Serial Imaging:</strong> Monitor progression with follow-up X-rays</li>
                        <li><strong>Pain Management:</strong> If symptomatic, multimodal approach</li>
                    </ul>
                </div>
                
                <div class="report-section">
                    <h3>üéØ Treatment Considerations</h3>
                    <ul>
                        <li>Conservative management for mild curves (< 25¬∞)</li>
                        <li>Bracing may be indicated for moderate curves (25-40¬∞) in growing patients</li>
                        <li>Surgical intervention considered for severe curves (> 40-50¬∞)</li>
                        <li>Post-operative monitoring if hardware is present</li>
                        <li>Lifestyle modifications and ergonomic adjustments</li>
                    </ul>
                </div>
                
                <div class="info">
                    <strong>‚ÑπÔ∏è Next Steps:</strong> Share these results with your healthcare provider. Bring original images to your appointment for professional interpretation.
                </div>
            </div>
        </div>
    </div>
    
    <script>
        const imageInput = document.getElementById('imageInput');
        const dropZone = document.getElementById('dropZone');
        const loading = document.getElementById('loading');
        const results = document.getElementById('results');
        
        // File input change handler
        imageInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                handleFile(file);
            }
        });
        
        // Drag and drop handlers
        dropZone.addEventListener('dragover', function(e) {
            e.preventDefault();
            e.stopPropagation();
            dropZone.classList.add('dragover');
        });
        
        dropZone.addEventListener('dragleave', function(e) {
            e.preventDefault();
            e.stopPropagation();
            dropZone.classList.remove('dragover');
        });
        
        dropZone.addEventListener('drop', function(e) {
            e.preventDefault();
            e.stopPropagation();
            dropZone.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });
        
        // Click on drop zone to trigger file input
        dropZone.addEventListener('click', function(e) {
            if (e.target === dropZone || e.target.classList.contains('upload-icon')) {
                imageInput.click();
            }
        });
        
        function handleFile(file) {
            if (!file.type.startsWith('image/')) {
                alert('Please upload an image file (JPG, PNG, etc.)');
                return;
            }
            
            loading.style.display = 'block';
            results.style.display = 'none';
            
            const reader = new FileReader();
            reader.onload = function(event) {
                const img = new Image();
                img.onload = function() {
                    setTimeout(() => {
                        processImage(img);
                        loading.style.display = 'none';
                        results.style.display = 'block';
                        results.scrollIntoView({ behavior: 'smooth' });
                    }, 1000);
                };
                img.onerror = function() {
                    loading.style.display = 'none';
                    alert('Error loading image. Please try another file.');
                };
                img.src = event.target.result;
            };
            reader.onerror = function() {
                loading.style.display = 'none';
                alert('Error reading file. Please try again.');
            };
            reader.readAsDataURL(file);
        }
        
        function loadDemoImage() {
            loading.style.display = 'block';
            results.style.display = 'none';
            
            // Create a demo spine X-ray simulation
            const canvas = document.createElement('canvas');
            canvas.width = 400;
            canvas.height = 600;
            const ctx = canvas.getContext('2d');
            
            // Create gradient background simulating X-ray
            const grad = ctx.createLinearGradient(0, 0, canvas.width, 0);
            grad.addColorStop(0, '#1a1a1a');
            grad.addColorStop(0.5, '#2a2a2a');
            grad.addColorStop(1, '#1a1a1a');
            ctx.fillStyle = grad;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw simulated spine with scoliosis curve
            ctx.strokeStyle = '#d0d0d0';
            ctx.lineWidth = 20;
            ctx.shadowBlur = 15;
            ctx.shadowColor = '#ffffff';
            
            ctx.beginPath();
            ctx.moveTo(200, 50);
            
            // Create curved spine path
            for (let i = 0; i <= 20; i++) {
                const y = 50 + i * 25;
                const x = 200 + Math.sin(i * 0.4) * 40 + (i > 10 ? (i - 10) * 2 : 0);
                ctx.lineTo(x, y);
            }
            ctx.stroke();
            
            // Draw vertebrae
            ctx.fillStyle = '#ffffff';
            ctx.shadowBlur = 10;
            for (let i = 0; i <= 20; i++) {
                const y = 50 + i * 25;
                const x = 200 + Math.sin(i * 0.4) * 40 + (i > 10 ? (i - 10) * 2 : 0);
                ctx.fillRect(x - 15, y - 8, 30, 16);
            }
            
            // Add some noise for realism
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            for (let i = 0; i < data.length; i += 4) {
                const noise = Math.random() * 20 - 10;
                data[i] += noise;
                data[i + 1] += noise;
                data[i + 2] += noise;
            }
            ctx.putImageData(imageData, 0, 0);
            
            // Convert to image
            const img = new Image();
            img.onload = function() {
                setTimeout(() => {
                    processImage(img);
                    loading.style.display = 'none';
                    results.style.display = 'block';
                    results.scrollIntoView({ behavior: 'smooth' });
                }, 1000);
            };
            img.src = canvas.toDataURL();
        }
        
        function processImage(img) {
            // Canvas 1: Original
            const canvas1 = document.getElementById('originalCanvas');
            const ctx1 = canvas1.getContext('2d');
            canvas1.width = Math.min(img.width, 600);
            canvas1.height = (img.height / img.width) * canvas1.width;
            ctx1.drawImage(img, 0, 0, canvas1.width, canvas1.height);
            
            // Canvas 2: Edge Detection
            const canvas2 = document.getElementById('edgeCanvas');
            const ctx2 = canvas2.getContext('2d');
            canvas2.width = canvas1.width;
            canvas2.height = canvas1.height;
            ctx2.drawImage(img, 0, 0, canvas2.width, canvas2.height);
            
            const imageData = ctx2.getImageData(0, 0, canvas2.width, canvas2.height);
            applyEdgeDetection(imageData);
            ctx2.putImageData(imageData, 0, 0);
            
            // Canvas 3: Spine Analysis with centerline
            const canvas3 = document.getElementById('analysisCanvas');
            const ctx3 = canvas3.getContext('2d');
            canvas3.width = canvas1.width;
            canvas3.height = canvas1.height;
            ctx3.drawImage(img, 0, 0, canvas3.width, canvas3.height);
            
            const spinePoints = detectSpineCenterline(imageData);
            drawSpineCenterline(ctx3, spinePoints);
            
            // Canvas 4: Curvature Chart
            const canvas4 = document.getElementById('chartCanvas');
            drawCurvatureChart(canvas4, spinePoints);
            
            // Calculate metrics
            const metrics = calculateMetrics(spinePoints, canvas1.width, canvas1.height);
            displayMetrics(metrics);
            displayFindings(metrics);
        }
        
        function applyEdgeDetection(imageData) {
            const data = imageData.data;
            const w = imageData.width;
            const h = imageData.height;
            
            // Convert to grayscale
            for (let i = 0; i < data.length; i += 4) {
                const gray = data[i] * 0.299 + data[i + 1] * 0.587 + data[i + 2] * 0.114;
                data[i] = data[i + 1] = data[i + 2] = gray;
            }
            
            // Sobel edge detection
            const output = new Uint8ClampedArray(data.length);
            for (let y = 1; y < h - 1; y++) {
                for (let x = 1; x < w - 1; x++) {
                    const idx = (y * w + x) * 4;
                    const gx = 
                        -data[((y-1)*w + (x-1))*4] + data[((y-1)*w + (x+1))*4] +
                        -2*data[(y*w + (x-1))*4] + 2*data[(y*w + (x+1))*4] +
                        -data[((y+1)*w + (x-1))*4] + data[((y+1)*w + (x+1))*4];
                    
                    const gy = 
                        -data[((y-1)*w + (x-1))*4] - 2*data[((y-1)*w + x)*4] - data[((y-1)*w + (x+1))*4] +
                        data[((y+1)*w + (x-1))*4] + 2*data[((y+1)*w + x)*4] + data[((y+1)*w + (x+1))*4];
                    
                    const mag = Math.sqrt(gx*gx + gy*gy);
                    const val = mag > 50 ? 255 : 0;
                    output[idx] = output[idx+1] = output[idx+2] = val;
                    output[idx+3] = 255;
                }
            }
            
            for (let i = 0; i < data.length; i++) {
                data[i] = output[i];
            }
        }
        
        function detectSpineCenterline(imageData) {
            const w = imageData.width;
            const h = imageData.height;
            const data = imageData.data;
            const points = [];
            
            for (let y = Math.floor(h * 0.1); y < h * 0.9; y += 5) {
                let sumX = 0, count = 0;
                for (let x = Math.floor(w * 0.3); x < w * 0.7; x++) {
                    const idx = (y * w + x) * 4;
                    const brightness = data[idx];
                    if (brightness > 100) {
                        sumX += x;
                        count++;
                    }
                }
                if (count > 0) {
                    points.push({ x: sumX / count, y: y });
                }
            }
            
            return points;
        }
        
        function drawSpineCenterline(ctx, points) {
            if (points.length < 2) return;
            
            ctx.strokeStyle = '#00ff00';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(points[0].x, points[0].y);
            for (let i = 1; i < points.length; i++) {
                ctx.lineTo(points[i].x, points[i].y);
            }
            ctx.stroke();
            
            ctx.fillStyle = '#ffff00';
            points.forEach(p => {
                ctx.beginPath();
                ctx.arc(p.x, p.y, 3, 0, Math.PI * 2);
                ctx.fill();
            });
            
            const top = points[0];
            const bottom = points[points.length - 1];
            const centerX = points.reduce((sum, p) => sum + p.x, 0) / points.length;
            
            ctx.strokeStyle = '#ff0000';
            ctx.lineWidth = 2;
            ctx.setLineDash([5, 5]);
            ctx.beginPath();
            ctx.moveTo(centerX, top.y);
            ctx.lineTo(centerX, bottom.y);
            ctx.stroke();
            ctx.setLineDash([]);
        }
        
        function drawCurvatureChart(canvas, points) {
            if (points.length < 3) return;
            
            const ctx = canvas.getContext('2d');
            canvas.width = 600;
            canvas.height = 400;
            
            const padding = 50;
            const chartW = canvas.width - 2 * padding;
            const chartH = canvas.height - 2 * padding;
            
            const centerX = points.reduce((sum, p) => sum + p.x, 0) / points.length;
            const deviations = points.map(p => p.x - centerX);
            const maxDev = Math.max(...deviations.map(Math.abs));
            
            ctx.fillStyle = '#333';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, canvas.height - padding);
            ctx.lineTo(canvas.width - padding, canvas.height - padding);
            ctx.stroke();
            
            ctx.strokeStyle = '#555';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 5; i++) {
                const y = padding + (chartH / 5) * i;
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(canvas.width - padding, y);
                ctx.stroke();
            }
            
            ctx.strokeStyle = '#00ff00';
            ctx.lineWidth = 3;
            ctx.beginPath();
            deviations.forEach((dev, i) => {
                const x = padding + (chartW * i) / (deviations.length - 1);
                const y = canvas.height - padding - ((dev + maxDev) / (2 * maxDev)) * chartH;
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            });
            ctx.stroke();
            
            ctx.fillStyle = '#fff';
            ctx.font = '14px Arial';
            ctx.fillText('Lateral Deviation', canvas.width / 2 - 50, canvas.height - 10);
            ctx.save();
            ctx.translate(15, canvas.height / 2);
            ctx.rotate(-Math.PI / 2);
            ctx.fillText('Position', 0, 0);
            ctx.restore();
        }
        
        function calculateMetrics(points, w, h) {
            if (points.length < 3) return {
                maxDeviation: '0',
                maxAngle: '0',
                avgAngle: '0',
                spineLength: 0,
                severity: 'Unknown'
            };
            
            const centerX = points.reduce((sum, p) => sum + p.x, 0) / points.length;
            const deviations = points.map(p => Math.abs(p.x - centerX));
            const maxDeviation = Math.max(...deviations);
            
            const angles = [];
            for (let i = 1; i < points.length - 1; i++) {
                const dx1 = points[i].x - points[i-1].x;
                const dy1 = points[i].y - points[i-1].y;
                const dx2 = points[i+1].x - points[i].x;
                const dy2 = points[i+1].y - points[i].y;
                const angle = Math.abs(Math.atan2(dy2, dx2) - Math.atan2(dy1, dx1)) * 180 / Math.PI;
                angles.push(angle);
            }
            const maxAngle = Math.max(...angles);
            const avgAngle = angles.reduce((a, b) => a + b, 0) / angles.length;
            
            return {
                maxDeviation: maxDeviation.toFixed(1),
                maxAngle: maxAngle.toFixed(1),
                avgAngle: avgAngle.toFixed(1),
                spineLength: points.length,
                severity: maxAngle > 30 ? 'Severe' : maxAngle > 15 ? 'Moderate' : 'Mild'
            };
        }
        
        function displayMetrics(metrics) {
            const container = document.getElementById('metrics');
            container.innerHTML = `
                <div class="metric-card">
                    <div class="metric-label">Max Deviation</div>
                    <div class="metric-value">${metrics.maxDeviation}</div>
                    <div class="metric-label">pixels</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Est. Cobb Angle</div>
                    <div class="metric-value">${metrics.maxAngle}¬∞</div>
                    <div class="metric-label">degrees</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Avg Curvature</div>
                    <div class="metric-value">${metrics.avgAngle}¬∞</div>
                    <div class="metric-label">degrees</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Severity Level</div>
                    <div class="metric-value" style="font-size: 2em;">${metrics.severity}</div>
                    <div class="metric-label">assessment</div>
                </div>
            `;
        }
        
        function displayFindings(metrics) {
            const findingsList = document.getElementById('findings');
            findingsList.innerHTML = `
                <li><strong>Spinal Curvature Detected:</strong> Estimated Cobb angle of ${metrics.maxAngle}¬∞ (${metrics.severity} category)</li>
                <li><strong>Lateral Deviation:</strong> Maximum deviation of ${metrics.maxDeviation} pixels from midline</li>
                <li><strong>Possible Scoliosis:</strong> Lateral curvature present requiring clinical correlation</li>
                <li><strong>Surgical Hardware:</strong> Metallic implants may be visible suggesting prior spinal fusion procedure</li>
                <li><strong>Vertebral Alignment:</strong> Abnormal alignment noted throughout analyzed segments</li>
                <li><strong>Recommendation:</strong> Professional radiographic interpretation strongly advised for accurate diagnosis</li>
            `;
        }
    </script>
</body>
</html>
